import { LineEdit, VerticalBox, HorizontalBox, Button, ComboBox } from "std-widgets.slint";

@rust-attr(derive(serde::Serialize, serde::Deserialize))
export enum SendMode {
    standard,
    frequency,
    debug,
}

component IpEdit inherits LineEdit {
    callback check-ip(text: string) -> bool;
    in-out property <bool> correct: true;

    edited(text) => {
        correct = check-ip(text)
    }
}

export component SettingsScreen {
    callback check-ip <=> listener-ip.check-ip;
    callback sync-interval-changed(string);
    callback back();
    callback send-mode-change(SendMode);

    in property <int> sync-interval;
    in property <string> listener-ip;
    in property <SendMode> send-mode;

    function num-send-mode(mode: SendMode) -> int {
        if send-mode == SendMode.standard { return 0; }
        else if send-mode == SendMode.frequency { return 1; }
        else if send-mode == SendMode.debug { return 2; }
        return 0;
    }

    TouchArea {}

    VerticalBox {
        padding: 10px;
        spacing: 10px;
        alignment: start;

        HorizontalBox {
            Button {
                icon: @image-url("icons/back.svg");
                clicked => {
                    back()
                }
                width: self.preferred-width;
            }
            Text {
                text: "Settings";
                horizontal-alignment: center;
                vertical-alignment: center;
                font-size: 16px;
            }
        }

        VerticalLayout {
            spacing: 2px;

            Text {
                text: "Listener IP";
            }
            listener-ip := IpEdit {
                text: root.listener-ip;
            }
            Text {
                text: "Reload the app to accept messages on new IP";
                font-italic: true;
            }
        }

        VerticalLayout {
            spacing: 2px;

            Text {
                text: "Auto sync interval";
            }
            LineEdit {
                text: sync-interval;
                edited(text) => {
                    sync-interval-changed(text);
                }
            }
        }

        VerticalLayout {
            spacing: 2px;

            Text {
                text: "Message send mode";
            }
            ComboBox {
                current-index: num-send-mode(root.send-mode);
                model: [
                    "Standard",
                    "Frequency",
                    "Debug",
                ];
                selected(current-value) => {
                    if self.current-index == 0 {
                        root.send-mode-change(SendMode.standard);
                    }
                    else if self.current-index == 1 {
                        root.send-mode-change(SendMode.frequency);
                    }
                    else if self.current-index == 2 {
                        root.send-mode-change(SendMode.debug);
                    }
                }
            }
        }
    }
}